{{- $titleFromContent := false -}}
{{- $foundTitle := partial "helpers/lib/metadata/find-page-title-base" . -}}
{{- if not $foundTitle -}}
    {{- if .IsHome -}}
        {{ with (partial "helpers/lib/metadata/gather-site-title" .) -}}
            {{- $foundTitle = . -}}
        {{- end -}}
    {{- else if .File -}}
        {{- if .File.ContentBaseName -}}
            {{- if .IsSection -}}
                {{- $foundTitle = .File.ContentBaseName | humanize | pluralize | title -}}
            {{- else -}}
                {{- $foundTitle = .File.ContentBaseName | humanize | title -}}
            {{- end -}}
        {{- end -}}
    {{- else -}}
        {{- $foundTitle = i18n "untitled" -}}
    {{- end -}}
{{- end -}}
{{- if $foundTitle -}}
    {{- $multipleH1 := false -}}
    {{- if not $titleFromContent -}}
        {{- /* Only allowed one h1 per page */ -}}
        {{- $multipleH1 = gt (len (findRE "<h1.*?>(.|\n)*?</h1>" .Content)) 0 -}}
    {{- else -}}
        {{- $multipleH1 = gt (len (findRE "<h1.*?>(.|\n)*?</h1>" .Content)) 1 -}}
    {{- end -}}
    {{- if eq (.Params.fixMultipleH1Error | default .Site.Params.fixMultipleH1Error) false -}}
        {{- if eq (.Params.warnMultipleH1Error | default .Site.Params.warnMultipleH1Error) true -}}
            {{- warnf "More than one H1 element (title + from content). This is against recommended best practises: https://developer.mozilla.org/en-US/docs/Web/HTML/Element/Heading_Elements#multiple_h1_elements_on_one_page" -}}
        {{- else if ne (.Params.ignoreMultipleH1Error | default .Site.Params.ignoreMultipleH1Error) true -}}
            {{- errorf "More than one H1 element (title + from content). This is against recommended best practises: https://developer.mozilla.org/en-US/docs/Web/HTML/Element/Heading_Elements#multiple_h1_elements_on_one_page" -}}
        {{- end -}}
    {{- end -}}
{{- end -}}
{{- return $foundTitle -}}