{{- $destination := .imageName -}}
{{- $images := .images -}}
{{- $inPage := .page -}}
{{- $relativeURL := .getRelative -}}
{{- $ignoreBundleAssets := .ignoreBundleAssets -}}
{{- $external := false -}}
{{- $tryInternalResource := false -}}
{{- if urls.Parse $destination -}}
    {{- $external = index (urls.Parse $destination).Scheme -}}
{{- end -}}
{{- if not $external -}}
    {{- $isFile := false -}}
    {{- /* We need to know the internal URL without any fragments (e.g. without #an-anchor) */ -}}
    {{- $path := (index (split $destination "#") 0) -}}
    {{- /* In a URL only a single unescaped '#' is valid, so this should work */ -}}
    {{- $fragment := (index (split $destination "#") 1) -}}
    {{- /* If we have a URL (not including fragment) */ -}}
    {{- if $path -}}
        {{- /* fileExists operates relative to site root not relative to applicable directory */ -}}
        {{- $filePath := path.Join "/static" $path -}}{{- /* Non-resource images must be in 'static' */ -}}
        {{- if fileExists $filePath -}}
            {{- $isFile = true -}}
        {{- end -}}
        {{- if $isFile -}}{{- /* If the file exists */ -}}
            {{- $destination = $path | absURL -}}
            {{- if $fragment -}}
                {{- if ne (path.Ext $path) "" -}}
                    {{- $destination = printf "%s#%s" $destination $fragment -}}
                {{- else -}}
                    {{- $destination = printf "%s/#%s" $destination $fragment -}}
                {{- end -}}
            {{- end -}}
        {{- else -}}
            {{- $tryInternalResource = true -}}
        {{- end -}}
    {{- end -}}
    {{- if $tryInternalResource -}}{{- /* Here we only try non-external resources */ -}}
        {{- $imageResource := false -}}
        {{- if ne $ignoreBundleAssets true -}}
            {{- $imageResources := $inPage.Resources.ByType "image" -}}
            {{- $imageResource = $imageResources.GetMatch (printf "*%s*" $destination) -}}
        {{- end -}}
        {{- if not $imageResource -}}
            {{- $imageResource = resources.Get $destination -}}
        {{- end -}}
        {{- if $imageResource -}}
            {{- $images = $images | append $imageResource.Permalink -}}
        {{- else if $inPage.File -}}
            {{- errorf (printf "Image %s is missing and not external for page %s" $destination $inPage.File.Path) -}}
        {{- else -}}
            {{- errorf (printf "Image %s is missing and not external for page %s" $destination $inPage.Title) -}}
        {{- end -}}
    {{- end -}}
{{- end -}}
{{- $images = $images | append $destination -}}
{{- return $images -}}